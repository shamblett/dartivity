/*
 * Package : dartivity
 * Author : S. Hamblett <steve.hamblett@linux.com>
 * Date   : 28/09/2015
 * Copyright :  S.Hamblett 2015
 */

library dartivity.test;

import 'dart:async';

import 'package:dartivity/dartivity.dart';

Future main() async {
  // Instantiate a Dartivity client and initialise for
  // messaging only
  Dartivity dartivity = new Dartivity(Mode.messagingOnly);
  await dartivity.initialise(
      DartivityCfg.MESS_CRED_PATH,
      DartivityCfg.MESS_PROJECT_ID);
  print("Initialse Status is ${dartivity.initialised}");

  // Send a couple of whoHas messages
  DartivityMessage whoHas1 =
  new DartivityMessage.whoHas(dartivity.id, '/core/light');
  dartivity.send(whoHas1);
  DartivityMessage whoHas2 =
  new DartivityMessage.whoHas(dartivity.id, '/core/thermostat');
  dartivity.send(whoHas2);

  // Followed by a I Have
  Map<String, String> myDevice = { 'iama' : 'thermostat', 'url' : 'here.com/ami'};
  DartivityMessage iHave = new DartivityMessage.iHave(dartivity.id, dartivity.id, '/core/therm/1', myDevice);
  dartivity.send(iHave);

  // Followed by a I Have but not for us
  Map<String, String> myDevice1 = { 'iama' : 'thermostat', 'url' : 'here.com/ami'};
  DartivityMessage iHave1 = new DartivityMessage.iHave(dartivity.id, 'not us', '/core/therm/1', myDevice1);
  dartivity.send(iHave1);

  // And a resource details
  DartivityMessage details = new DartivityMessage.details(dartivity.id, dartivity.id, '/core/therm/1', myDevice);
  dartivity.send(details);

  // Listen for our messages until our timer pops
  var subscription;

  void timerCallback() {
    print("Closing the client");
    subscription.cancel();
    try {
      dartivity.close();
    } catch (e) {
    }
  }
  Timer timer = new Timer(new Duration(seconds: (DartivityCfg.MESS_PULL_TIME_INTERVAL * 6 + 2)), timerCallback);
  subscription = dartivity.nextMessage.listen((DartivityMessage message) {
    print("Message received ${message.toString()}");
  });
}
